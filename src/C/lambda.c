#include "leg2cheb.h"

inline static double chebval(const double x, const double *c, const size_t N) {
  const double x2 = 2 * x;
  double c0 = c[N - 2];
  double c1 = c[N - 1];
  for (size_t i = 3; i < N + 1; i++) {
    double tmp = c0;
    c0 = c[N - i] - c1;
    c1 = tmp + c1 * x2;
  }
  return c0 + c1 * x;
}

void Lambdavec(const double *z, double *w, const size_t N) {
  for (size_t i = 0; i < N; i++)
    w[i] = Lambda(z[i]);
}

double _Lambda0(const double z) { return exp(lgamma(z + 0.5) - lgamma(z + 1)); }

inline static double _LambdaE16(const double z) {
  const static double a0[5] = {9.9996949706645188e-01, -3.0498055973040047e-05,
                               4.8752082058744936e-09, -2.3645121623003757e-12,
                               2.4013727207097398e-15};
  const double z0 = z + 0.25;
  return chebval(-1 + 512 / pow(z0, 2), a0, 5) / sqrt(z0);
}

inline static double _LambdaE32(const double z) {
  const static double a0[4] = {9.9999237152186726e-01, -7.6281727285568499e-06,
                               3.0536699868997274e-10, -3.7171802006655959e-14};
  const double z0 = z + 0.25;
  return chebval(-1 + 2048 / pow(z0, 2), a0, 4) / sqrt(z0);
}

inline static double _LambdaE128(const double z) {
  const static double a0[3] = {9.9999952316642282e-01, -4.7683238349233873e-07,
                               1.1936572376807404e-12};
  const double z0 = z + 0.25;
  return chebval(-1 + 32768 / pow(z0, 2), a0, 3) / sqrt(z0);
}

inline static double _LambdaE1400(const double z) {
  const static double a0[2] = {9.9999999601403089e-01, -3.9859690541081902e-09};
  const double z0 = z + 0.25;
  // return chebval(-1 + 3920000 / pow(z0, 2), a0, 2) / sqrt(z0);
  return (a0[0] + a0[1] * (-1 + 3920000 / pow(z0, 2))) / sqrt(z0);
}

double _LambdaE(const double z) {
  if (z < 16)
    return _LambdaE(z+1)*(z+1)/(z+0.5);

  if (z > 1400) {
    return _LambdaE1400(z);
  } else if (z > 128) {
    return _LambdaE128(z);
  } else if (z > 32) {
    return _LambdaE32(z);
  }
  return _LambdaE16(z);
}

double Lambda(const double z) {
  double zz, y;
  const double zp = z + 0.25;
  const double s = 1 / sqrt(zp);
  const double z2 = 1 / (zp * zp);

  if (z < 10)
    return Lambda(z+1)*(z+1)/(z+0.5);

  y = 1 - 1.5625e-02 * z2;
  if (z > 2014) // 2000
    goto scalereturn;
  zz = z2 * z2;
  y += 2.5634765625e-03 * zz;
  if (z > 141) // 92
    goto scalereturn;
  zz *= z2;
  y -= 1.2798309326171875e-03 * zz;
  if (z > 40) // 31
    goto scalereturn;
  zz *= z2;
  y += 1.343511044979095458984375e-03 * zz;
  if (z > 20)
    goto scalereturn;
  zz *= z2;
  y -= 2.4328966392204165e-03 * zz;
  if (z > 14)
    goto scalereturn;
  zz *= z2;
  y += 6.754237533641572e-03 * zz;
  goto scalereturn;
scalereturn:
  return y * s;
}

// Lambda with integer argument. For initializing direct solver
double LambdaI(const size_t z) {
  const static double LamInt[256] = {
      1.7724538509055161e+00, 8.8622692545275805e-01, 6.6467019408956851e-01,
      5.5389182840797380e-01, 4.8465534985697706e-01, 4.3618981487127934e-01,
      3.9984066363200604e-01, 3.7128061622971992e-01, 3.4807557771536241e-01,
      3.2873804562006448e-01, 3.1230114333906128e-01, 2.9810563682364938e-01,
      2.8568456862266400e-01, 2.7469670059871537e-01, 2.6488610414876129e-01,
      2.5605656734380255e-01, 2.4805479961430874e-01, 2.4075907021388790e-01,
      2.3407131826350211e-01, 2.2791154673025205e-01, 2.2221375806199575e-01,
      2.1692295429861491e-01, 2.1199288715546458e-01, 2.0738434613034576e-01,
      2.0306383891929691e-01, 1.9900256214091097e-01, 1.9517558979204730e-01,
      1.9156122701812048e-01, 1.8814049082136833e-01, 1.8489668925548267e-01,
      1.8181507776789130e-01, 1.7888257651357048e-01, 1.7608753625554593e-01,
      1.7341954328197706e-01, 1.7086925588077151e-01, 1.6842826651104620e-01,
      1.6608898503172612e-01, 1.6384453928805415e-01, 1.6168869008689554e-01,
      1.5961575816270457e-01, 1.5762056118567075e-01, 1.5569835921999184e-01,
      1.5384480732451575e-01, 1.5205591421609116e-01, 1.5032800609999922e-01,
      1.4865769492111033e-01, 1.4704185041109827e-01, 1.4547757540672487e-01,
      1.4396218399623817e-01, 1.4249318211872553e-01, 1.4106825029753828e-01,
      1.3968522823579768e-01, 1.3834210104122271e-01, 1.3703698688045646e-01,
      1.3576812589082260e-01, 1.3453387020090604e-01, 1.3333267493125509e-01,
      1.3216309006343707e-01, 1.3102375308013156e-01, 1.2991338229131691e-01,
      1.2883077077222260e-01, 1.2777478084786012e-01, 1.2674433906682897e-01,
      1.2573843161391765e-01, 1.2475610011693392e-01, 1.2379643780834211e-01,
      1.2285858600676376e-01, 1.2194173088731031e-01, 1.2104510051313890e-01,
      1.2016796210362340e-01, 1.1930961951716895e-01, 1.1846941092901987e-01,
      1.1764670668645723e-01, 1.1684090732559109e-01, 1.1605144173555330e-01,
      1.1527776545731629e-01, 1.1451935910562341e-01, 1.1377572690363885e-01,
      1.1304639532092321e-01, 1.1233091180623384e-01, 1.1162884360744486e-01,
      1.1093977667159645e-01, 1.1026331461872085e-01, 1.0959907778366831e-01,
      1.0894670232067029e-01, 1.0830583936584282e-01, 1.0767615425325071e-01,
      1.0705732578053088e-01, 1.0644904552041423e-01, 1.0585101717479392e-01,
      1.0526295596826729e-01, 1.0468458807833175e-01, 1.0411565009964517e-01,
      1.0355588853996966e-01, 1.0300505934560812e-01, 1.0246292745431544e-01,
      1.0192926637382421e-01, 1.0140385778426843e-01, 1.0088649116292012e-01,
      1.0037696342977405e-01, 9.9875078612625179e-02, 9.9380647530384461e-02,
      9.8893487493470808e-02, 9.8413422020201535e-02, 9.7940280568181340e-02,
      9.7473898279761426e-02, 9.7014115740705953e-02, 9.6560778751263399e-02,
      9.6113738108896438e-02, 9.5672849401974888e-02, 9.5237972813784100e-02,
      9.4808972936244532e-02, 9.4385718592779153e-02, 9.3968082669802250e-02,
      9.3555941956338207e-02, 9.3149176991310659e-02, 9.2747671918072247e-02,
      9.2351314345772789e-02, 9.1959995217189006e-02, 9.1573608682663010e-02,
      9.1192051979818570e-02, 9.0815225318744947e-02, 9.0443031772356644e-02,
      9.0075377171656007e-02, 8.9712170005641273e-02, 8.9353321325618698e-02,
      8.8998744653691647e-02, 8.8648355895212541e-02, 8.8302073254996866e-02,
      8.7959817157109280e-02, 8.7621510168043482e-02, 8.7287076923127288e-02,
      8.6956444055994217e-02, 8.6629540130971683e-02, 8.6306295578244180e-02,
      8.5986642631658089e-02, 8.5670515269041708e-02, 8.5357849154921117e-02,
      8.5048581585519228e-02, 8.4742651435931030e-02, 8.4439999109374136e-02,
      8.4140566488418903e-02, 8.3844296888107572e-02, 8.3551135010876423e-02,
      8.3261026903199767e-02, 8.2973919913878397e-02, 8.2689762653899351e-02,
      8.2408504957797654e-02, 8.2130097846453740e-02, 8.1854493491264307e-02,
      8.1581645179626752e-02, 8.1311507281680975e-02, 8.1044035218254387e-02,
      8.0779185429959446e-02, 8.0516915347394635e-02, 8.0257183362403048e-02,
      7.9999948800344056e-02, 7.9745171893336589e-02, 7.9492813754433622e-02,
      7.9242836352690124e-02, 7.8995202489087965e-02, 7.8749875773283351e-02,
      7.8506820601143584e-02, 7.8266002133041912e-02, 7.8027386272880209e-02,
      7.7790939647810864e-02, 7.7556629588630716e-02, 7.7324424110820439e-02,
      7.7094291896204911e-02, 7.6866202275210224e-02, 7.6640125209694890e-02,
      7.6416031276333216e-02, 7.6193891650529921e-02, 7.5973678090846306e-02,
      7.5755362923918587e-02, 7.5538919029850243e-02, 7.5324319828060898e-02,
      7.5111539263574847e-02, 7.4900551793733353e-02, 7.4691332375315098e-02,
      7.4483856452050343e-02, 7.4278099942514289e-02, 7.4074039228386498e-02,
      7.3871651143063044e-02, 7.3670912960609070e-02, 7.3471802385039850e-02,
      7.3274297539918778e-02, 7.3078376958261235e-02, 7.2884019572733952e-02,
      7.2691204706139420e-02, 7.2499912062175889e-02, 7.2310121716463394e-02,
      7.2121814107826768e-02, 7.1934970029827211e-02, 7.1749570622533843e-02,
      7.1565597364527347e-02, 7.1383032065128041e-02, 7.1201856856840912e-02,
      7.1022054188010511e-02, 7.0843606815678820e-02, 7.0666497798639621e-02,
      7.0490710490682812e-02, 7.0316228534022709e-02, 7.0143035852904420e-02,
      6.9971116647382606e-02, 6.9800455387267035e-02, 6.9631036806229979e-02,
      6.9462845896070005e-02, 6.9295867901127531e-02, 6.9130088312847310e-02,
      6.8965492864483391e-02, 6.8802067525941965e-02, 6.8639798498758134e-02,
      6.8478672211202365e-02, 6.8318675313512642e-02, 6.8159794673248661e-02,
      6.8002017370764292e-02, 6.7845330694794787e-02, 6.7689722138155342e-02,
      6.7535179393547681e-02, 6.7381690349471446e-02, 6.7229243086237345e-02,
      6.7077825872079153e-02, 6.6927427159361480e-02, 6.6778035580880774e-02,
      6.6629639946256591e-02, 6.6482229238410892e-02, 6.6335792610132449e-02,
      6.6190319380724269e-02, 6.6045799032731417e-02, 6.5902221208747211e-02,
      6.5759575708295381e-02, 6.5617852484786132e-02, 6.5477041642544101e-02,
      6.5337133433906180e-02, 6.5198118256387230e-02, 6.5059986649911833e-02,
      6.4922729294110332e-02, 6.4786337005677333e-02, 6.4650800735790978e-02,
      6.4516111567591405e-02, 6.4382260713716735e-02, 6.4249239513895010e-02,
      6.4117039432590700e-02, 6.3985652056704242e-02, 6.3855069093323211e-02,
      6.3725282367523783e-02, 6.3596283820221103e-02, 6.3468065506067428e-02,
      6.3340619591396613e-02, 6.3213938352213811e-02, 6.3088014172229326e-02,
      6.2962839540935220e-02, 6.2838407051723888e-02, 6.2714709400047267e-02,
      6.2591739381615802e-02};
  if (z > 255)
    return Lambda((const double)z);
  return LamInt[z];
}
