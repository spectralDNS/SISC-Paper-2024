#include "leg2cheb.h"

// Some experimental and different implementations for the DCT of size 18
// Some are much faster due to compiler optimization (simd/avx) than others.

void fft9c(fftw_complex *x) {

  static const double M_SQRT3_2 = 0.86602540378443865e0;
  static const fftw_complex W9[5] = {
      (fftw_complex){1, 0},
      (fftw_complex){0.76604444311897803514, -0.64278760968653932562},
      (fftw_complex){0.17364817766693034983, -0.98480775301220805935},
      (fftw_complex){-0.49999999999999999957, -0.8660254037844386469},
      (fftw_complex){-0.93969262078590838367, -0.3420201433256687350}};

  static const fftw_complex W3[2] = {(fftw_complex){-0.5, -M_SQRT3_2},
                                     (fftw_complex){-0.5, M_SQRT3_2}};

  fftw_complex z0[3] = {x[0] + x[3] + x[6], x[1] + x[4] + x[7],
                        x[2] + x[5] + x[8]};
  fftw_complex z1[3] = {(x[0] + x[3] * W3[0] + x[6] * W3[1]),
                        (x[1] + x[4] * W3[0] + x[7] * W3[1]) * W9[1],
                        (x[2] + x[5] * W3[0] + x[8] * W3[1]) * W9[2]};
  fftw_complex z2[3] = {(x[0] + x[3] * W3[1] + x[6] * W3[0]),
                        (x[1] + x[4] * W3[1] + x[7] * W3[0]) * W9[2],
                        (x[2] + x[5] * W3[1] + x[8] * W3[0]) * W9[4]};

  x[0] = z0[0] + z0[1] + z0[2];
  x[1] = z1[0] + z1[1] + z1[2];
  x[2] = z2[0] + z2[1] + z2[2];
  x[3] = z0[0] + z0[1] * W3[0] + z0[2] * W3[1];
  x[4] = z1[0] + z1[1] * W3[0] + z1[2] * W3[1];
  x[5] = z2[0] + z2[1] * W3[0] + z2[2] * W3[1];
  x[6] = z0[0] + z0[1] * W3[1] + z0[2] * W3[0];
  x[7] = z1[0] + z1[1] * W3[1] + z1[2] * W3[0];
  x[8] = z2[0] + z2[1] * W3[1] + z2[2] * W3[0];
}

void fft9(fftw_complex *x) {
  static const double M_SQRT3_2 = 0.86602540378443865e0;
  static const double M_SIN_2 = 0.64278760968653932e0;
  static const double M_SIN_4 = 0.984807753012208059e0;
  static const double M_SIN_8 = 0.3420201433256687330e0;
  static const double M_COS_2 = 0.76604444311897803e0;
  static const double M_COS_4 = 0.173648177666930348e0;
  static const double M_COS_8 = -0.939692620785908384e0;
  static const fftw_complex W3[2] = {(fftw_complex){-0.5, -M_SQRT3_2},
                                     (fftw_complex){-0.5, M_SQRT3_2}};
  static const fftw_complex WN[6] = {
      (fftw_complex){M_COS_2, -M_SIN_2}, (fftw_complex){M_COS_4, -M_SIN_4},
      (fftw_complex){M_COS_8, -M_SIN_8}, (fftw_complex){M_COS_2, M_SIN_2},
      (fftw_complex){M_COS_4, M_SIN_4},  (fftw_complex){M_COS_8, M_SIN_8}};

  fftw_complex px[3] = {x[3] + x[6], x[4] + x[7], x[5] + x[8]};
  fftw_complex mx[3] = {
      (fftw_complex){(cimag(x[3]) - cimag(x[6])) * M_SQRT3_2,
                     (creal(x[6]) - creal(x[3])) * M_SQRT3_2},
      (fftw_complex){(cimag(x[4]) - cimag(x[7])) * M_SQRT3_2,
                     (creal(x[7]) - creal(x[4])) * M_SQRT3_2},
      (fftw_complex){(cimag(x[5]) - cimag(x[8])) * M_SQRT3_2,
                     (creal(x[8]) - creal(x[5])) * M_SQRT3_2}};

  fftw_complex z0[3] = {x[0] + px[0], x[1] + px[1], x[2] + px[2]};
  fftw_complex pxa[3] = {-px[0] * 0.5, -px[1] * 0.5, -px[2] * 0.5};
  fftw_complex z1[3] = {x[0] + pxa[0] + mx[0], x[1] + pxa[1] + mx[1],
                        x[2] + pxa[2] + mx[2]};
  fftw_complex z2[3] = {x[0] + pxa[0] - mx[0], x[1] + pxa[1] - mx[1],
                        x[2] + pxa[2] - mx[2]};

  x[0] = z0[0] + z0[1] + z0[2];
  x[1] = z1[0] + z1[1] * WN[0] + z1[2] * WN[1];
  x[2] = z2[0] + z2[1] * WN[1] + z2[2] * WN[2];
  x[3] = z0[0] + z0[1] * W3[0] + z0[2] * W3[1];
  x[4] = z1[0] + z1[1] * WN[2] + z1[2] * WN[3];
  x[5] = z2[0] + z2[1] * WN[5] + z2[2] * WN[0];
  x[6] = z0[0] + z0[1] * W3[1] + z0[2] * W3[0];
  x[7] = z1[0] + z1[1] * WN[4] + z1[2] * WN[5];
  x[8] = z2[0] + z2[1] * WN[3] + z2[2] * WN[4];
}

void dct_fft(double *input, double *output, size_t st) {
  double v[18];
  fftw_complex V[10];
  static const fftw_complex IW18[5] = {
      (fftw_complex){0.0, 1.0},
      (fftw_complex){0.34202014332566871, 0.93969262078590843},
      (fftw_complex){0.64278760968653925, 0.76604444311897801},
      (fftw_complex){0.8660254037844386, 0.5},
      (fftw_complex){0.98480775301220802, 0.17364817766693041}};
  static const fftw_complex F[10] = {
      (fftw_complex){1.0, 0.0},
      (fftw_complex){0.4980973490458727661475, -0.043577871373829086779026},
      (fftw_complex){0.49240387650610402968321, -0.086824088833465174425753},
      (fftw_complex){0.48296291314453414337468, -0.12940952255126038117463},
      (fftw_complex){0.46984631039295419202707, -0.17101007166283436652188},
      (fftw_complex){0.45315389351832498162138, -0.21130913087034971809338},
      (fftw_complex){0.43301270189221932338157, -0.25},
      (fftw_complex){0.4095760221444958948422, -0.28678821817552304805412},
      (fftw_complex){0.38302222155948901760132, -0.32139380484326966316133},
      (fftw_complex){0.70710678118654752440138, -0.70710678118654752440053}};

  for (size_t i = 0; i < 9; i++) {
    v[i] = input[2 * i * st];
    v[9 + i] = input[(17 - 2 * i) * st];
  }
  fftw_complex y[9] = {
      (fftw_complex){v[0], v[1]},   (fftw_complex){v[2], v[3]},
      (fftw_complex){v[4], v[5]},   (fftw_complex){v[6], v[7]},
      (fftw_complex){v[8], v[9]},   (fftw_complex){v[10], v[11]},
      (fftw_complex){v[12], v[13]}, (fftw_complex){v[14], v[15]},
      (fftw_complex){v[16], v[17]}};

  fft9(y);

  for (size_t k = 1; k < 5; k++) {
    fftw_complex a = y[k] + conj(y[9 - k]);
    fftw_complex b = IW18[k] * (y[k] - conj(y[9 - k]));
    V[k] = (a - b) * F[k];
    V[9 - k] = conj(a + b) * F[9 - k];
  }
  V[0] = (fftw_complex){creal(y[0]) + cimag(y[0]), 0};
  double tmp = (creal(y[0]) - cimag(y[0])) * creal(F[9]);
  V[9] = (fftw_complex){tmp, -tmp};

  for (size_t i = 0; i < 10; i++) {
    output[i * st] = creal(V[i]);
  }
  for (size_t i = 0; i < 9; i++) {
    output[(9 + i) * st] = -cimag(V[9 - i]);
  }
}

void dct0(double *input, double *output, size_t st) {
  double out[18], z[9];
  // cos(i*(2*j+1)*pi/18) (9 x 9)
  static const double DCTII[81] __attribute__((aligned)) = {
      1.000000000000000000e+00,  1.000000000000000000e+00,
      1.000000000000000000e+00,  1.000000000000000000e+00,
      1.000000000000000000e+00,  1.000000000000000000e+00,
      1.000000000000000000e+00,  1.000000000000000000e+00,
      1.000000000000000000e+00,  9.848077530122080203e-01,
      8.660254037844385966e-01,  6.427876096865393629e-01,
      3.420201433256687129e-01,  0.000000000000000000e+00,
      -3.420201433256687129e-01, -6.427876096865393629e-01,
      -8.660254037844385966e-01, -9.848077530122080203e-01,
      9.396926207859084279e-01,  5.000000000000000000e-01,
      -1.736481776669303589e-01, -7.660444431189780135e-01,
      -1.000000000000000000e+00, -7.660444431189780135e-01,
      -1.736481776669303589e-01, 5.000000000000000000e-01,
      9.396926207859084279e-01,  8.660254037844385966e-01,
      0.000000000000000000e+00,  -8.660254037844385966e-01,
      -8.660254037844385966e-01, 0.000000000000000000e+00,
      8.660254037844385966e-01,  8.660254037844385966e-01,
      0.000000000000000000e+00,  -8.660254037844385966e-01,
      7.660444431189780135e-01,  -5.000000000000000000e-01,
      -9.396926207859084279e-01, 1.736481776669303589e-01,
      1.000000000000000000e+00,  1.736481776669303589e-01,
      -9.396926207859084279e-01, -5.000000000000000000e-01,
      7.660444431189780135e-01,  6.427876096865393629e-01,
      -8.660254037844385966e-01, -3.420201433256687129e-01,
      9.848077530122080203e-01,  0.000000000000000000e+00,
      -9.848077530122080203e-01, 3.420201433256687129e-01,
      8.660254037844385966e-01,  -6.427876096865393629e-01,
      5.000000000000000000e-01,  -1.000000000000000000e+00,
      5.000000000000000000e-01,  5.000000000000000000e-01,
      -1.000000000000000000e+00, 5.000000000000000000e-01,
      5.000000000000000000e-01,  -1.000000000000000000e+00,
      5.000000000000000000e-01,  3.420201433256687129e-01,
      -8.660254037844385966e-01, 9.848077530122080203e-01,
      -6.427876096865393629e-01, 0.000000000000000000e+00,
      6.427876096865393629e-01,  -9.848077530122080203e-01,
      8.660254037844385966e-01,  -3.420201433256687129e-01,
      1.736481776669303589e-01,  -5.000000000000000000e-01,
      7.660444431189780135e-01,  -9.396926207859084279e-01,
      1.000000000000000000e+00,  -9.396926207859084279e-01,
      7.660444431189780135e-01,  -5.000000000000000000e-01,
      1.736481776669303589e-01};

  // Remaining four are parts (4 x 4) of cos((2*i+1)*(2*j+1)*pi/36) (9 x 9)
  static const double DCTIIa[16] __attribute__((aligned)) = {
      9.961946980917455452e-01,  9.659258262890683122e-01,
      9.063077870366499367e-01,  8.191520442889917986e-01,
      9.659258262890683122e-01,  7.071067811865475727e-01,
      2.588190451025207395e-01,  -2.588190451025207395e-01,
      9.063077870366499367e-01,  2.588190451025207395e-01,
      -5.735764363510460484e-01, -9.961946980917455452e-01,
      8.191520442889917986e-01,  -2.588190451025207395e-01,
      -9.961946980917455452e-01, -4.226182617406994413e-01};
  static const double DCTIIb[16] __attribute__((aligned)) = {
      5.735764363510460484e-01,  4.226182617406994413e-01,
      2.588190451025207395e-01,  8.715574274765817975e-02,
      -9.659258262890683122e-01, -9.659258262890683122e-01,
      -7.071067811865475727e-01, -2.588190451025207395e-01,
      8.715574274765817975e-02,  8.191520442889917986e-01,
      9.659258262890683122e-01,  4.226182617406994413e-01,
      9.063077870366499367e-01,  -8.715574274765817975e-02,
      -9.659258262890683122e-01, -5.735764363510460484e-01,
  };
  static const double DCTIIc[16] __attribute__((aligned)) = {
      5.735764363510460484e-01, -9.659258262890683122e-01,
      8.715574274765817975e-02, 9.063077870366499367e-01,
      4.226182617406994413e-01, -9.659258262890683122e-01,
      8.191520442889917986e-01, -8.715574274765817975e-02,
      2.588190451025207395e-01, -7.071067811865475727e-01,
      9.659258262890683122e-01, -9.659258262890683122e-01,
      8.715574274765817975e-02, -2.588190451025207395e-01,
      4.226182617406994413e-01, -5.735764363510460484e-01};
  static const double DCTIId[16] __attribute__((aligned)) = {
      -4.226182617406994413e-01, 9.961946980917455452e-01,
      -2.588190451025207395e-01, -8.191520442889917986e-01,
      9.961946980917455452e-01,  -5.735764363510460484e-01,
      -2.588190451025207395e-01, 9.063077870366499367e-01,
      -2.588190451025207395e-01, -2.588190451025207395e-01,
      7.071067811865475727e-01,  -9.659258262890683122e-01,
      -8.191520442889917986e-01, 9.063077870366499367e-01,
      -9.659258262890683122e-01, 9.961946980917455452e-01};

  out[0] = 0;
  for (size_t i = 0; i < 9; i++) {
    z[i] = input[i * st] + input[(17 - i) * st];
    out[0] += z[i];
  }
  for (size_t i = 1; i < 9; i++) {
    out[2 * i] = 0;
    for (size_t j = 0; j < 9; j++) {
      out[2 * i] += DCTII[i * 9 + j] * z[j];
    }
  }
  // cblas_dgemv(CblasRowMajor, CblasNoTrans, 8, 9, 1, &DCTII[9], 9, &z[0], 1,
  //                     0, &out[2], 2);

  // odd indices
  for (size_t i = 0; i < 9; i++) {
    z[i] -= 2 * input[(17 - i) * st];
  }

  double z0 = DCTIIa[5] * z[4];
  out[1] = z0;
  out[3] = -z0;
  out[5] = -z0;
  out[7] = z0;
  out[9] = (z[0] - z[1] - z[2] + z[3] + z[4] - z[5] - z[6] + z[7] + z[8]) *
           DCTIIa[5];
  out[11] = -z0;
  out[13] = -z0;
  out[15] = z0;
  out[17] = z0;

  for (size_t i = 0; i < 4; i++) {
    double s0 = 0;
    double s1 = 0;
    for (size_t j = 0; j < 4; j++) {
      s0 += DCTIIa[i * 4 + j] * z[j] + DCTIIb[i * 4 + j] * z[j + 5];
      s1 += DCTIIc[i * 4 + j] * z[j] + DCTIId[i * 4 + j] * z[j + 5];
    }
    out[1 + 2 * i] += s0;
    out[1 + 2 * (i + 5)] += s1;
  }

  for (size_t i = 0; i < 18; i++) {
    output[i * st] = out[i];
  }
}

// Hard-coded DCT II for N=18
void dct(double *input, double *output, size_t st) {
  double out[18], z[9], zpm[9];
  // cos(i*(2*j+1)*pi/9) (5 x 5)
  static const double DCTIIHH0[25] __attribute__((aligned)) = {
      1.000000000000000000e+00,  1.000000000000000000e+00,
      1.000000000000000000e+00,  1.000000000000000000e+00,
      1.000000000000000000e+00,  9.396926207859084279e-01,
      5.000000000000000000e-01,  -1.736481776669303589e-01,
      -7.660444431189780135e-01, -1.000000000000000000e+00,
      7.660444431189780135e-01,  -5.000000000000000000e-01,
      -9.396926207859084279e-01, 1.736481776669303589e-01,
      1.000000000000000000e+00,  5.000000000000000000e-01,
      -1.000000000000000000e+00, 5.000000000000000000e-01,
      5.000000000000000000e-01,  -1.000000000000000000e+00,
      1.736481776669303589e-01,  -5.000000000000000000e-01,
      7.660444431189780135e-01,  -9.396926207859084279e-01,
      1.000000000000000000e+00};
  // cos((2*i+1)*(2*j+1)*pi/18) (4 x 4)
  static const double DCTIIHH1[16] __attribute__((aligned)) = {
      9.848077530122080203e-01,  8.660254037844385966e-01,
      6.427876096865393629e-01,  3.420201433256687129e-01,
      8.660254037844385966e-01,  0.000000000000000000e+00,
      -8.660254037844385966e-01, -8.660254037844385966e-01,
      6.427876096865393629e-01,  -8.660254037844385966e-01,
      -3.420201433256687129e-01, 9.848077530122080203e-01,
      3.420201433256687129e-01,  -8.660254037844385966e-01,
      9.848077530122080203e-01,  -6.427876096865393629e-01};
  // Remaining four are parts (4 x 4) of cos((2*i+1)*(2*j+1)*pi/36) (9 x 9)
  static const double DCTIIa[16] __attribute__((aligned)) = {
      9.961946980917455452e-01,  9.659258262890683122e-01,
      9.063077870366499367e-01,  8.191520442889917986e-01,
      9.659258262890683122e-01,  7.071067811865475727e-01,
      2.588190451025207395e-01,  -2.588190451025207395e-01,
      9.063077870366499367e-01,  2.588190451025207395e-01,
      -5.735764363510460484e-01, -9.961946980917455452e-01,
      8.191520442889917986e-01,  -2.588190451025207395e-01,
      -9.961946980917455452e-01, -4.226182617406994413e-01};
  static const double DCTIIb[16] __attribute__((aligned)) = {
      5.735764363510460484e-01,  4.226182617406994413e-01,
      2.588190451025207395e-01,  8.715574274765817975e-02,
      -9.659258262890683122e-01, -9.659258262890683122e-01,
      -7.071067811865475727e-01, -2.588190451025207395e-01,
      8.715574274765817975e-02,  8.191520442889917986e-01,
      9.659258262890683122e-01,  4.226182617406994413e-01,
      9.063077870366499367e-01,  -8.715574274765817975e-02,
      -9.659258262890683122e-01, -5.735764363510460484e-01,
  };
  static const double DCTIIc[16] __attribute__((aligned)) = {
      5.735764363510460484e-01, -9.659258262890683122e-01,
      8.715574274765817975e-02, 9.063077870366499367e-01,
      4.226182617406994413e-01, -9.659258262890683122e-01,
      8.191520442889917986e-01, -8.715574274765817975e-02,
      2.588190451025207395e-01, -7.071067811865475727e-01,
      9.659258262890683122e-01, -9.659258262890683122e-01,
      8.715574274765817975e-02, -2.588190451025207395e-01,
      4.226182617406994413e-01, -5.735764363510460484e-01};
  static const double DCTIId[16] __attribute__((aligned)) = {
      -4.226182617406994413e-01, 9.961946980917455452e-01,
      -2.588190451025207395e-01, -8.191520442889917986e-01,
      9.961946980917455452e-01,  -5.735764363510460484e-01,
      -2.588190451025207395e-01, 9.063077870366499367e-01,
      -2.588190451025207395e-01, -2.588190451025207395e-01,
      7.071067811865475727e-01,  -9.659258262890683122e-01,
      -8.191520442889917986e-01, 9.063077870366499367e-01,
      -9.659258262890683122e-01, 9.961946980917455452e-01};

  for (size_t i = 0; i < 9; i++) {
    z[i] = input[i * st] + input[(17 - i) * st];
  }
  for (size_t i = 0; i < 4; i++) {
    zpm[i] = z[i] + z[8 - i];
    zpm[5 + i] = z[i] - z[8 - i];
  }
  zpm[4] = z[4];

  out[0] = (zpm[0] + zpm[1] + zpm[2] + zpm[3] + zpm[4]);
  for (size_t i = 1; i < 5; i++) {
    const double *t0 = &DCTIIHH0[i * 5];
    out[4 * i] = t0[0] * zpm[0] + t0[1] * zpm[1] + t0[2] * zpm[2] +
                 t0[3] * zpm[3] + t0[4] * zpm[4];
  }
  for (size_t i = 0; i < 4; i++) {
    const double *t1 = &DCTIIHH1[i * 4];
    out[2 + 4 * i] =
        t1[0] * zpm[5] + t1[1] * zpm[6] + t1[2] * zpm[7] + t1[3] * zpm[8];
  }

  for (size_t i = 0; i < 9; i++) {
    z[i] -= 2 * input[(17 - i) * st];
  }

  double z0 = DCTIIa[5] * z[4];
  out[1] = z0;
  out[3] = -z0;
  out[5] = -z0;
  out[7] = z0;
  out[9] = (z[0] - z[1] - z[2] + z[3] + z[4] - z[5] - z[6] + z[7] + z[8]) *
           DCTIIa[5];
  out[11] = -z0;
  out[13] = -z0;
  out[15] = z0;
  out[17] = z0;

  for (size_t i = 0; i < 4; i++) {
    double s0 = 0;
    double s1 = 0;
    for (size_t j = 0; j < 4; j++) {
      s0 += DCTIIa[i * 4 + j] * z[j] + DCTIIb[i * 4 + j] * z[j + 5];
      s1 += DCTIIc[i * 4 + j] * z[j] + DCTIId[i * 4 + j] * z[j + 5];
    }
    out[1 + 2 * i] += s0;
    out[1 + 2 * (i + 5)] += s1;
  }

  for (size_t i = 0; i < 18; i++) {
    output[i * st] = out[i];
  }
}

void dct_radix2(double *input, double *output, size_t st) {
  double out[18], z[9], zp[5], zm[4], T[9];
  static const double DCTIIHH0[25] __attribute__((aligned)) = {
      1.000000000000000000e+00,  1.000000000000000000e+00,
      1.000000000000000000e+00,  1.000000000000000000e+00,
      1.000000000000000000e+00,  9.396926207859084279e-01,
      5.000000000000000000e-01,  -1.736481776669303589e-01,
      -7.660444431189780135e-01, -1.000000000000000000e+00,
      7.660444431189780135e-01,  -5.000000000000000000e-01,
      -9.396926207859084279e-01, 1.736481776669303589e-01,
      1.000000000000000000e+00,  5.000000000000000000e-01,
      -1.000000000000000000e+00, 5.000000000000000000e-01,
      5.000000000000000000e-01,  -1.000000000000000000e+00,
      1.736481776669303589e-01,  -5.000000000000000000e-01,
      7.660444431189780135e-01,  -9.396926207859084279e-01,
      1.000000000000000000e+00};
  static const double DCTIIHH1[16] __attribute__((aligned)) = {
      9.848077530122080203e-01,  8.660254037844385966e-01,
      6.427876096865393629e-01,  3.420201433256687129e-01,
      8.660254037844385966e-01,  0.000000000000000000e+00,
      -8.660254037844385966e-01, -8.660254037844385966e-01,
      6.427876096865393629e-01,  -8.660254037844385966e-01,
      -3.420201433256687129e-01, 9.848077530122080203e-01,
      3.420201433256687129e-01,  -8.660254037844385966e-01,
      9.848077530122080203e-01,  -6.427876096865393629e-01};

  // 2*cos(pi*(i+0.5)/18)
  static const double COSH[9] __attribute__((aligned)) = {
      1.992389396183491090e+00, 1.931851652578136624e+00,
      1.812615574073299873e+00, 1.638304088577983597e+00,
      1.414213562373095145e+00, 1.147152872702092097e+00,
      8.452365234813988826e-01, 5.176380902050414790e-01,
      1.743114854953163595e-01};

  for (size_t i = 0; i < 9; i++) {
    z[i] = input[i * st] + input[(17 - i) * st];
  }
  for (size_t i = 0; i < 4; i++) {
    zp[i] = z[i] + z[8 - i];
    zm[i] = z[i] - z[8 - i];
  }
  zp[4] = z[4];

  out[0] = (zp[0] + zp[1] + zp[2] + zp[3] + zp[4]);
  for (size_t i = 1; i < 5; i++) {
    const double *t0 = &DCTIIHH0[i * 5];
    out[4 * i] = t0[0] * zp[0] + t0[1] * zp[1] + t0[2] * zp[2] + t0[3] * zp[3] +
                 t0[4] * zp[4];
  }
  for (size_t i = 0; i < 4; i++) {
    const double *t1 = &DCTIIHH1[i * 4];
    out[4 * i + 2] =
        t1[0] * zm[0] + t1[1] * zm[1] + t1[2] * zm[2] + t1[3] * zm[3];
  }

  // odd indices
  for (size_t i = 0; i < 9; i++) {
    z[i] = (input[i * st] - input[(17 - i) * st]) * COSH[i];
  }

  out[1] = (z[0] + z[1] + z[2] + z[3] + z[4] + z[5] + z[6] + z[7] + z[8]) / 2;

  for (size_t i = 0; i < 4; i++) {
    zp[i] = z[i] + z[8 - i];
    zm[i] = z[i] - z[8 - i];
  }
  zp[4] = z[4];

  for (size_t i = 1; i < 5; i++) {
    const double *t0 = &DCTIIHH0[i * 5];
    T[2 * i] = t0[0] * zp[0] + t0[1] * zp[1] + t0[2] * zp[2] + t0[3] * zp[3] +
               t0[4] * zp[4];
  }
  for (size_t i = 0; i < 4; i++) {
    const double *t1 = &DCTIIHH1[i * 4];
    T[2 * i + 1] =
        t1[0] * zm[0] + t1[1] * zm[1] + t1[2] * zm[2] + t1[3] * zm[3];
  }

  for (size_t i = 1; i < 9; i++) {
    out[2 * i + 1] = T[i] - out[2 * i - 1];
  }

  for (size_t i = 0; i < 18; i++) {
    output[i * st] = out[i];
  }
}

// Mixed radix 2 and 3 algorithm
void dct_radix23(double *input, double *output, size_t st) {
  double out[18], z[9], B[3], C[3], T[9];
  double f[3], g[3], h[3], t[3];

  static const double M_SQRT3_2 = 8.660254037844385966e-01;
  // sqrt(3)*sin(pi*(i+0.5)/9)
  static const double SIN[3] __attribute__((aligned)) = {
      3.007674663608705945e-01, 8.660254037844385966e-01,
      1.326827896337876789e+00};
  // sqrt(3)*sin(2*pi*(i+0.5)/9)
  static const double SIN2[3] __attribute__((aligned)) = {
      5.923962654520477100e-01, 1.500000000000000000e+00,
      1.705737063904886330e+00};
  // cos(pi*(i+0.5)/9)
  static const double COS[3] __attribute__((aligned)) = {
      9.848077530122080203e-01, 8.660254037844385966e-01,
      6.427876096865393629e-01};
  // cos(2*pi*(i+0.5)/9)
  static const double COS2[3] __attribute__((aligned)) = {
      9.396926207859084279e-01, 5.000000000000000000e-01,
      -1.736481776669303589e-01};
  // 2*cos(pi*(i+0.5)/18)
  static const double COSH[9] __attribute__((aligned)) = {
      1.992389396183491090e+00, 1.931851652578136624e+00,
      1.812615574073299873e+00, 1.638304088577983597e+00,
      1.414213562373095145e+00, 1.147152872702092097e+00,
      8.452365234813988826e-01, 5.176380902050414790e-01,
      1.743114854953163595e-01};

  // even indices
  for (size_t i = 0; i < 9; i++) { // radix 2
    z[i] = input[i * st] + input[(17 - i) * st];
  }

  // radix 3 on the 9 even indices
  for (size_t i = 0; i < 3; i++) {
    f[i] = z[i] + z[5 - i] + z[6 + i];
    t[i] = 2 * z[i] - z[5 - i] - z[6 + i];
  }

  for (size_t i = 0; i < 3; i++) {
    double tmp = z[5 - i] - z[6 + i];
    g[i] = t[i] * COS[i] + tmp * SIN[i];
    h[i] = t[i] * COS2[i] - tmp * SIN2[i];
  }

  B[0] = g[0] + g[1] + g[2];
  B[1] = M_SQRT3_2 * (g[0] - g[2]);
  B[2] = 0.5 * (g[0] + g[2]) - g[1];
  C[0] = h[0] + h[1] + h[2];
  C[1] = M_SQRT3_2 * (h[0] - h[2]);
  C[2] = 0.5 * (h[0] + h[2]) - h[1];
  out[0] = f[0] + f[1] + f[2];
  out[3] = M_SQRT3_2 * (f[0] - f[2]);
  out[6] = 0.5 * (f[0] + f[2]) - f[1];
  out[1] = B[0] * 0.5;
  out[2] = C[0] * 0.5;
  out[4] = B[1] - out[2];
  out[5] = C[1] - out[1];
  out[7] = B[2] - out[5];
  out[8] = C[2] - out[4];

  // odd indices
  for (size_t i = 0; i < 9; i++) {
    z[i] = (input[i * st] - input[(17 - i) * st]) * COSH[i];
  }

  // radix 3 on the 9 odd indices
  for (size_t i = 0; i < 3; i++) {
    f[i] = z[i] + z[5 - i] + z[6 + i];
  }
  out[9] = (f[0] + f[1] + f[2]) * 0.5; // T[0] is out[9]
  T[3] = M_SQRT3_2 * (f[0] - f[2]);
  T[6] = 0.5 * (f[0] + f[2]) - f[1];

  for (size_t i = 0; i < 3; i++) {
    t[i] = 3 * z[i] - f[i];
  }

  for (size_t i = 0; i < 3; i++) {
    double tmp = z[5 - i] - z[6 + i];
    g[i] = t[i] * COS[i] + tmp * SIN[i];
    h[i] = t[i] * COS2[i] - tmp * SIN2[i];
  }

  B[0] = g[0] + g[1] + g[2];
  B[1] = M_SQRT3_2 * (g[0] - g[2]);
  B[2] = 0.5 * (g[0] + g[2]) - g[1];
  C[0] = h[0] + h[1] + h[2];
  C[1] = M_SQRT3_2 * (h[0] - h[2]);
  C[2] = 0.5 * (h[0] + h[2]) - h[1];
  T[1] = B[0] * 0.5;
  T[2] = C[0] * 0.5;
  T[4] = B[1] - T[2];
  T[5] = C[1] - T[1];
  T[7] = B[2] - T[5];
  T[8] = C[2] - T[4];

  for (size_t i = 1; i < 9; i++) {
    out[9 + i] = T[i] - out[8 + i];
  }

  for (size_t i = 0; i < 9; i++) {
    output[2 * i * st] = out[i];
    output[(2 * i + 1) * st] = out[9 + i];
  }
}

void dct2(double *input, double *output) {
  double tmp[324];
  static const double sc = 1.0 / 81.0;
  for (size_t i = 0; i < 18; i++) {
    dct_radix23(input + i * 18, tmp + i * 18, 1);
  }
  for (size_t i = 0; i < 18; i++) {
    dct_radix23(tmp + i, output + i, 18);
  }
  for (size_t i = 0; i < 324; i++) {
    output[i] *= sc;
  }
  for (size_t i = 0; i < 18; i++) {
    output[i] *= 0.5;
    output[i * 18] *= 0.5;
  }
}
